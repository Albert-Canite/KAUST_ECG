# 四分类异常预测（仅输出 S/V）的原因与修复建议

## 1. 日志暴露的症状
- 训练日志显示：权重采样器 power=1.0 与逆频率 CE 权重 **同时启用**，S/V 的权重高达 7.49/6.60，而 N 仅 0.31（均值约 4.11）。【F:logs.txt†L9-L16】
- 所有验证/泛化混淆矩阵都只有第 1、2 列（S、V）非零，N/O 被完全忽略；第一批样本的 softmax 概率在 0.05~0.09 区间近乎均匀，但 argmax 始终落在 S 或 V，说明决策面被权重强行偏向稀有类。【F:logs.txt†L17-L200】

## 2. 逻辑层面的根因
1) **“采样 + CE 叠加”过度抵消先验**：采样器已把训练分布重采样为近乎均匀，再叠加 7.5×/6.6× 的 CE 权重，相当于把 S/V 的有效损失提升了几十倍，把真实先验彻底翻转，模型最优解就是“无论输入都预测 S/V”。
2) **权重范围未随采样器调整**：权重计算仍按均匀先验、`max_ratio=20`，没有在“已启用采样器”时下调，导致翻倍效应无人制动。
3) **输出层缺乏校准**：从样本概率可以看出 logits 差距并不大，但类别决策被极端权重主导，说明问题在损失配置而非特征表示或数据质量。

## 3. 建议的修改（按风险从低到高）
1) **关闭叠加（首选）**：训练命令加入 `--no-stack-sampler-with-ce`，只保留采样器或只保留 CE 权重，让两者其一负责均衡，避免过补偿。
2) **必须叠加时，减小权重幅度**：
   - 把 `class_weight_power` 降到 0.3~0.5，或把 `class_weight_max_ratio` 降到 4~5；同时在 `train.py` 中，当 `sampler` 不为空时强制使用均匀 CE 权重（覆盖现有可选分支），确保采样器主导再平衡。
   - 增加打印：记录最终 CE 权重和采样器状态，防止出现权重>5、采样器已等频仍继续放大。
3) **权重热身改为“真热身”**：日志显示 warmup 仍是 `alpha=1.0`（等于未生效）。将 `--weight_warmup_epochs` 设为 5~10，并在 `constraints.py` 中把默认 warmup alpha 起点改为 0（线性从 0→1），首轮只用均匀权重，避免一开始就被极端权重锁死在 S/V。
4) **验证步骤**：重新训练时先在前 1~2 epoch 观察混淆矩阵是否开始出现 N/O 召回；若仍全为 S/V，再进一步调低 CE 权重或直接关闭叠加。上述操作应能在不改模型结构的情况下解除预测坍塌。

## 4. 复现与验证要点
- 重新训练时记录权重打印，确认 N/S/V/O 的 CE 权重与采样策略是否符合预期（稀有类>1，但不至于反向碾压常见类）。
- 关注前 1~2 个 epoch 的混淆矩阵是否开始出现 N/O 召回；若仍全为 S/V，再降低 CE 权重或直接关闭叠加。
- 若关闭叠加后仍崩塌，再检查数据管线（类别计数）或模型结构，但当前日志已指向损失配置为主要原因。
