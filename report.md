# 四分类异常预测（仅输出 S/V）的原因与修复建议

## 1. 日志暴露的症状
- 训练日志显示：权重采样器 power=1.0 与逆频率 CE 权重 **同时启用**，S/V 的权重高达 7.49/6.60，而 N 仅 0.31（均值约 4.11）。【F:logs.txt†L9-L16】
- 所有验证/泛化混淆矩阵都只有第 1、2 列（S、V）非零，N/O 被完全忽略；第一批样本的 softmax 概率在 0.05~0.09 区间近乎均匀，但 argmax 始终落在 S 或 V，说明决策面被权重强行偏向稀有类。【F:logs.txt†L17-L200】

## 2. 逻辑层面的根因
1) **“采样 + CE 叠加”过度抵消先验**：采样器已把训练分布重采样为近乎均匀，再叠加 7.5×/6.6× 的 CE 权重，相当于把 S/V 的有效损失提升了几十倍，把真实先验彻底翻转，模型最优解就是“无论输入都预测 S/V”。
2) **权重范围未随采样器调整**：权重计算仍按均匀先验、`max_ratio=20`，没有在“已启用采样器”时下调，导致翻倍效应无人制动。
3) **输出层缺乏校准**：从样本概率可以看出 logits 差距并不大，但类别决策被极端权重主导，说明问题在损失配置而非特征表示或数据质量。

## 3. 建议的修改（按风险从低到高）
1) **关闭叠加（首选）**：训练命令加入 `--no-stack-sampler-with-ce`，只保留采样器或只保留 CE 权重，让两者其一负责均衡，避免过补偿。
2) **必须叠加时，减小权重幅度**：
   - 把 `class_weight_power` 降到 0.3~0.5，或把 `class_weight_max_ratio` 降到 4~5；同时在 `train.py` 中，当 `sampler` 不为空时强制使用均匀 CE 权重（覆盖现有可选分支），确保采样器主导再平衡。
   - 增加打印：记录最终 CE 权重和采样器状态，防止出现权重>5、采样器已等频仍继续放大。
3) **权重热身改为“真热身”**：日志显示 warmup 仍是 `alpha=1.0`（等于未生效）。将 `--weight_warmup_epochs` 设为 5~10，并在 `constraints.py` 中把默认 warmup alpha 起点改为 0（线性从 0→1），首轮只用均匀权重，避免一开始就被极端权重锁死在 S/V。
4) **验证步骤**：重新训练时先在前 1~2 epoch 观察混淆矩阵是否开始出现 N/O 召回；若仍全为 S/V，再进一步调低 CE 权重或直接关闭叠加。上述操作应能在不改模型结构的情况下解除预测坍塌。

## 4. 复现与验证要点
- 重新训练时记录权重打印，确认 N/S/V/O 的 CE 权重与采样策略是否符合预期（稀有类>1，但不至于反向碾压常见类）。
- 关注前 1~2 个 epoch 的混淆矩阵是否开始出现 N/O 召回；若仍全为 S/V，再降低 CE 权重或直接关闭叠加。
- 若关闭叠加后仍崩塌，再检查数据管线（类别计数）或模型结构，但当前日志已指向损失配置为主要原因。

---

## 追加反思（KD 暂停后学生模型仍弱）

### 发现的问题
- 最近日志（Val MacroF1≈0.41、Gen MacroF1≈0.36）显示学生模型在 S/V/O 上普遍低召回，Gen 的 S 类几乎为 0.01，说明训练批次仍被 N 类主导，稀有类曝光不足。
- 早停依据只看 Val MacroF1，但验证集来源于同一批训练记录，患者分布与 Generalization 集差异大，且 MacroF1 中 N 类仍占 25% 的权重，允许“全预测 N”在轻微召回稀有类时触发早停。

### 修正措施
- **默认开启 weighted sampler**：将 `use_weighted_sampler` 默认值设为 `True`，在不叠加 CE 权重的前提下让批次近似均衡，避免稀有类训练信号稀薄。
- **关注稀有类的早停指标**：新增 `abnormal_macro_f1`（对 S/V/O 取均值），早停/保存最好模型使用 MacroF1 与 abnormal MacroF1 的平均值，防止“全 N”模型因 N 类高精度被误判为最佳。
- **降低 CE 权重幂次**：将 `class_weight_power` 默认值下调为 0.5，避免未来手动关闭采样器时重新引入过强的类权重。

### 预期效果与验证
- 训练日志将打印 `(abn …)` 指标，若早期 epoch 中 abnormal MacroF1 持续上升，说明稀有类已被有效抽样参与训练；若依旧停滞，可继续调高采样器 `power` 或加长耐心。新的早停分数会偏向同时提升 S/V/O 表现的模型，缓解 Val/Gen 分布差异带来的“伪最佳”问题。

## 最新实验复盘（准确率≈0.36 停滞）

- 现象：最新日志（Val MacroF1≈0.28/Acc≈0.37，Gen MacroF1≈0.29）显示模型大量把 N 判为 S，混淆矩阵的 S 列远高于其余列，说明采样仍过度推高了少数类先验，导致决策面偏向 S 类。
- 原因：我们默认启用了 weighted sampler，且 `sampler_power=1.0`、无权重上限，等价于把极少数的 S 样本重复抽取到接近平衡甚至更高的比例；当 CE 权重又保持均匀时，模型会把 S 当作“新的多数类”，从而整体倾向 S。
- 修正：
  1) 将采样幂次下调为 `sampler_power=0.7`，
  2) 为采样权重增加 `sampler_max_ratio`（默认 6.0）并记录到日志，防止单类权重爆炸。
  新增打印每类采样权重，训练开始即能确认采样力度。
- 后续验证要点：
  - 观察前 1–2 epoch 的混淆矩阵，确认 N 的召回不再掉到 0.35 以下；如果仍偏向 S，则进一步降低 `sampler_max_ratio`（如 4–5）或暂时关闭采样仅用 CE 权重。
  - 若采样收敛但仍低召回，可考虑重新启用温和的 CE 权重（`class_weight_power` 0.3–0.5）或加长耐心，避免早停过早。
